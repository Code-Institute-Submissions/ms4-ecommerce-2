{% extends "base.html" %}
{% load static %}
{% load bag_tools %}

{% block extra_css %}
    <link href="{% static 'shopping_bag/styles/styles.css' %}" rel="stylesheet" type="text/css">
{% endblock %}

{% block content %}

    <div class="container">
        <div class="row">
            <div class="col-12 py-5">
                <h1>Shopping Bag</h1>
            </div>
        </div>


        {% if bag_items %}
            <div class="row shopping-wrapper">
                <table class="w-100">
                    {% for item in bag_items %}
                    {{item}}
                        <tr class="products-row ">
                            <td>
                                <div class="img-wrapper text-center">
                                    {% if item.product.image %}
                                        <img src="{{ item.product.image.url }}" alt="{{ item.product.name}}">
                                    {% elif item.product.image_url %}
                                        <img src="{{ item.product.image_url }}" alt="{{ item.product.name}}">
                                    {% else %}
                                        <img src="{{ MEDIA_URL }}noimage.jpeg" alt="{{ item.product.name}}">
                                    {% endif %}
                                </div>
                            </td>

                            <td class="">
                                <div class="card-texts ">
                                    <p class="card-title"><strong>{{ item.product.name }}</strong></p>
                                    {% if item.product.has_size %}
                                        <p>Size: {{item.size|upper}}</p>
                                    {% endif %}
                                        <p class="card-text d-none d-md-block">{{ item.product.description|truncatechars:150 }}</p>
                                    <div class="description ">
                                    </div>
                                    
                                    <!--p class="card-text"><small class="text-muted">Last updated 3 mins ago</small></!--p-->
                                <form id="update-form" class="update-form" method="POST" action="{% url 'edit_bag' item.product_pk %}">
                                    <div class="edit-section">
                                        <input class="form-control form-control-lg form-select-size text-center d-inline-block w-25" name="quantity" type="number" value="{{ item.quantity }}" min="1" max="99" data-item-id="{{ product.pk }}" id="id_qty_{{ product.pk }}">
                                    </div>
                                </form>
                                <a href="" id="update-item-{{item.product_pk}}" class="update-item btn btn-success me-1">
                                    <span class="edit-item">Update</span>
                                </a>
                                <a href="" id="remove-item-{{item.product_pk}}" class="remove-item btn btn-danger me-1" data-product_size="{{ item.product.size }}">
                                    <span class="edit-item">Remove</span>
                                </a>
                            </td>
                            
                            <td>
                                <div class="price-wrapper p-2">
                                    <p class="d-inline-block d-sm-block">x{{ item.quantity }}</p>
                                    <p class="card-text d-inline-block d-sm-block">&#163;{{ item.product.price | calc_subtotal:item.quantity }}</p>
                                    <!--hr class="d-none d-sm-block">
                                    <p-- class="d-none d-sm-block">&#163;{{ item.total }}</p-->
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </table>
            </div>
            
            <div class="row shopping-wrapper my-4 py-4">
                <div class="col-md-9 col-lg-9"></div>
                <div class="col-md-3 col-lg-3">
                    <table class="w-100">
                        <tr>
                            <td>
                                <span class="">Sub total: </span>
                            </td>
                            <td>&#163;{{ total }}</td>
                        </tr>
                        <tr>
                            <td>
                                <span>Delivery: </span>
                            </td>
                            <td>
                                <span class="text-center">{% if delivery == 0 %} Free {% else %} &#163;{{ delivery }} {% endif %}</span>
                            </td>
                        </tr>
                        <tr>
                            <td class="w-100">
                                <span class="text-right">Total ({% if products_count > 1 %}{{ products_count }} items{% else %} {{ products_count }} item {% endif %}): </span>
                            </td>
                            <td class="w-100">
                                <p class="">&#163;{{ grand_total }}</p>
                            </td>
                        </tr>
                        <tr>
                            <td><a href="{% url 'checkout' %}" class="btn btn-info">Checkout</a></td>
                        </tr>
                    
                    </table>
                </div>
            </div>
        {% else %}
            <div class="row">
                <p class="message-empty">Your bag is empty</p>
                <h3><a href="{% url 'home'%}" class="btn btn-info">Back to the main page</a></h3>
            </div>
        {% endif %}
    </div>

{% endblock %}

{% block postload_js %}
    {{ block.super }}
    {#% include 'products/includes/quantity_input_script.html' %#}

    <script>
        // Update quantity
        $('.update-item').click(function(e){
            var form = $(this).prev('.update-form');
            form.submit();
        });

        // Remove Item
        $("#remove-item").click(function(e){
            var csrfToken = "{{ csrf_token }}";
            var productPk = $(this).attr('remove-item-').slice[1];
            var size = $(this).data('size');
            var url = `/bag/remove/${productPk}/`;
            var data = {'csrfmiddlewaretoken': csrfToken, 'size': size}

            // POST
            $.post(url, data).done(function() {
                location.reload();
            });
        });
    </script>
{% endblock %}